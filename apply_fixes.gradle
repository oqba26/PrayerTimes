// ÙØ§ÛŒÙ„ Gradle Task Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª
// Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø±Ø§ Ø¯Ø± root Ù¾Ø±ÙˆÚ˜Ù‡ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯ Ùˆ Ø³Ù¾Ø³ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯

task applyPrayerTimesFixes {
    group 'custom'
    description 'Apply all fixes for PrayerTimes project'
    
    doLast {
        println "ğŸš€ Ø´Ø±ÙˆØ¹ Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª..."
        
        // 1. Ø§ÛŒØ¬Ø§Ø¯ local.properties
        def localPropsFile = file('local.properties')
        if (!localPropsFile.exists()) {
            localPropsFile.text = '''# This file contains the path of the Android SDK location.
# For information on how to configure your Android SDK, please refer to the documentation.
# Example (Windows):
# sdk.dir=C\\:\\Users\\YourName\\AppData\\Local\\Android\\Sdk
# Example (macOS/Linux):
# sdk.dir=/Users/YourName/Library/Android/sdk

# Note: You need to set the actual path to your Android SDK
# sdk.dir=/path/to/your/android-sdk'''
            println "âœ… ÙØ§ÛŒÙ„ local.properties Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
        } else {
            println "âš ï¸ ÙØ§ÛŒÙ„ local.properties Ø§Ø² Ù‚Ø¨Ù„ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª"
        }
        
        // 2. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ PrayerUtils.kt
        def prayerUtilsFile = file('app/src/main/java/com/oqba26/prayertimes/utils/PrayerUtils.kt')
        prayerUtilsFile.text = '''package com.oqba26.prayertimes.utils

import android.content.Context
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken
import com.oqba26.prayertimes.models.MultiDate
import java.io.InputStreamReader

fun getPrayerTimes(context: Context, date: MultiDate): Map<String, String> {
    try {
        val inputStream = context.assets.open("prayer_times.json")
        val reader = InputStreamReader(inputStream)
        val type = object : TypeToken<Map<String, Map<String, String>>>() {}.type
        val data: Map<String, Map<String, String>> = Gson().fromJson(reader, type)
        reader.close()
        inputStream.close()
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø§Ù‡ Ùˆ Ø±ÙˆØ² Ø§Ø² ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ 12 Ù…Ø§Ù‡Ù‡
        val monthDay = extractMonthDay(date.shamsi)
        return data[monthDay] ?: getDefaultPrayerTimes()
    } catch (e: Exception) {
        e.printStackTrace()
        return getDefaultPrayerTimes()
    }
}

private fun extractMonthDay(shamsiDate: String): String {
    // Ø§Ø² ØªØ§Ø±ÛŒØ® Ú©Ø§Ù…Ù„ Ù…Ø«Ù„ "1403/01/15" ÙÙ‚Ø· "01/15" Ø±Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ÛŒâ€ŒÚ©Ù†Ù‡
    val parts = shamsiDate.split("/")
    return if (parts.size >= 3) {
        "${parts[1]}/${parts[2]}"
    } else {
        shamsiDate
    }
}

private fun getDefaultPrayerTimes(): Map<String, String> {
    return linkedMapOf(
        "Ø·Ù„ÙˆØ¹ Ø¨Ø§Ù…Ø¯Ø§Ø¯" to "05:00",
        "Ø·Ù„ÙˆØ¹ Ø®ÙˆØ±Ø´ÛŒØ¯" to "06:30",
        "Ø¸Ù‡Ø±" to "12:30",
        "Ø¹ØµØ±" to "16:00",
        "ØºØ±ÙˆØ¨" to "18:30",
        "Ø¹Ø´Ø§Ø¡" to "20:00"
    )
}'''
        println "âœ… PrayerUtils.kt Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯"
        
        // 3. Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ JSON Ù†Ù…ÙˆÙ†Ù‡
        def assetsDir = file('app/src/main/assets')
        if (!assetsDir.exists()) {
            assetsDir.mkdirs()
        }
        
        def sampleJsonFile = file('app/src/main/assets/prayer_times_sample.json')
        sampleJsonFile.text = '''{
  "_comment": "Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ù†Ù…ÙˆÙ†Ù‡ Ø§Ø³Øª. ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ prayer_times.json Ø±Ø§ Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù…Ù„ Ø®ÙˆØ¯ØªØ§Ù† Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯",
  "01/01": {
    "Ø·Ù„ÙˆØ¹ Ø¨Ø§Ù…Ø¯Ø§Ø¯": "05:15",
    "Ø·Ù„ÙˆØ¹ Ø®ÙˆØ±Ø´ÛŒØ¯": "06:45",
    "Ø¸Ù‡Ø±": "12:15",
    "Ø¹ØµØ±": "15:45",
    "ØºØ±ÙˆØ¨": "18:00",
    "Ø¹Ø´Ø§Ø¡": "19:30"
  },
  "01/02": {
    "Ø·Ù„ÙˆØ¹ Ø¨Ø§Ù…Ø¯Ø§Ø¯": "05:14",
    "Ø·Ù„ÙˆØ¹ Ø®ÙˆØ±Ø´ÛŒØ¯": "06:44",
    "Ø¸Ù‡Ø±": "12:15",
    "Ø¹ØµØ±": "15:46",
    "ØºØ±ÙˆØ¨": "18:01",
    "Ø¹Ø´Ø§Ø¡": "19:31"
  },
  "01/03": {
    "Ø·Ù„ÙˆØ¹ Ø¨Ø§Ù…Ø¯Ø§Ø¯": "05:13",
    "Ø·Ù„ÙˆØ¹ Ø®ÙˆØ±Ø´ÛŒØ¯": "06:43",
    "Ø¸Ù‡Ø±": "12:16",
    "Ø¹ØµØ±": "15:47",
    "ØºØ±ÙˆØ¨": "18:02",
    "Ø¹Ø´Ø§Ø¡": "19:32"
  }
}'''
        println "âœ… ÙØ§ÛŒÙ„ JSON Ù†Ù…ÙˆÙ†Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
        
        println "ğŸ‰ Ù‡Ù…Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯!"
        println ""
        println "ğŸ“‹ Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯ÛŒ:"
        println "1. Ù…Ø³ÛŒØ± Android SDK Ø±Ø§ Ø¯Ø± local.properties ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯"
        println "2. ÙØ§ÛŒÙ„ prayer_times.json Ø±Ø§ Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù…Ù„ Ø®ÙˆØ¯ØªØ§Ù† Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯"
        println "3. Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ Sync Ú©Ù†ÛŒØ¯"
    }
}